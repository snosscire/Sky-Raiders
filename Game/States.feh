class State {
	boolean active;
	boolean listenersRegistered;
	function init();
	function quit();
	function update();
	function draw();
}

class TestState extends State {
	object map;
	object playerCamera;
	object player;
	function init() {
		.map = Map.load("Test");
		
		.playerCamera = new Camera();
		
		.player = new Player();
		.player.controller = new KeyboardPlayerController(.player);
		.player.controller.keyLeft = Engine.KEY_LEFT;
		.player.controller.keyRight = Engine.KEY_RIGHT;
		.player.controller.keyShoot = Engine.KEY_SPACE;
		.player.controller.keyKill = Engine.KEY_k;
		.player.weapon = new MachineGun(.player);
		.player.speed = Global.PlayerSpeed;
		.player.turningSpeed = Global.PlayerTurningSpeed;
		.player.x = Global.PlayerStartX;
		.player.y = Global.PlayerStartY;
		
		.active = true;
		
		if( not .listenersRegistered ) {
			EventHandler.registerListener(Engine.EVENT_KEYDOWN, self);
		}
	}
	function quit() {
		.active = false;
		.player = null;
		.map.unload();
		.map = null;
	}
	function update() {
		//number deltaTime = Time.delta;
		//while( deltaTime > 0 ) {
		//	.player.update(deltaTime);
		//	deltaTime -= 5;
		//}
		.player.update(Time.delta, .map);
		.playerCamera.update(.map, .player);
		.map.update(.playerCamera);
	}
	function draw() {
		.map.drawBackground(.playerCamera);
		.player.draw(.playerCamera, .map);
		.map.drawForeground(.playerCamera);
	}
	function onKeyDown( object event ) {
		if( .active and (not Console.active) ) {
			if( event.key == Engine.KEY_ESCAPE ) {
				Game.setState(Game.menuState());
			}
		}
	}
}

class MultiplayerState extends State {
	object client;
	boolean connected;
	object currentMap;
	object playerCamera;
	object localPlayer;
	array players;
	boolean connectAutomatically;
	string host;
	number port;
	
	function setConnectAutomatically( string host, number port ) {
		.connectAutomatically = true;
		.host = host;
		.port = port;
	}
	
	function init() {
		if( not .listenersRegistered ) {
			EventHandler.registerListener(Engine.EVENT_KEYDOWN, self);
			MessageHandler.registerListener(Network.MESSAGE_DISCONNECT_ME, self);
			MessageHandler.registerListener(Network.MESSAGE_CONNECT, self);
			MessageHandler.registerListener(Network.MESSAGE_NEW_PLAYER, self);
			.listenersRegistered = true;
		}
		.currentMap = Map.load("Test");
		.playerCamera = new Camera();
		.connected = false;
		.active = true;
		if( .connectAutomatically ) {
			Console.printLine("------------------ connect ----------------------");
			Console.printLine("connecting to ${.host}:${.port}...");
			Console.flush();
			Network.disconnect();
			if( Network.connect(.host, .port, 'Player') ) {
				Console.printLine('waiting for response....');
			} else {
				Console.printLine('failed.');
			}
		}
	}
	function quit() {
		.active = false;
		.connected = false;
		.currentMap and .currentMap.unload();
		.currentMap = null;
		.playerCamera = null;
		.localPlayer = null;
		.players = [];
		Game.players = [];
		Network.disconnect();
	}
	function update() {
		if( .connected ) {
			//number deltaTime;
			.players.each() using ( player ) {
				//player.me and Console.printLine('updating me...');
				player.update(Time.delta, .currentMap);
				//deltaTime = Time.delta;
				//Engine.printLine("Player: ${player.id}, delta time: ${deltaTime}");
				//while( deltaTime > 0 ) {
				//	player.update(deltaTime);
				//	deltaTime -= 5;
				//}
			};
			//.localPlayer.update(Time.delta, .currentMap);
			.playerCamera.update(.currentMap, .localPlayer);
			.currentMap.update(.playerCamera);
		}
	}
	function draw() {
		if( .connected ) {
			.currentMap.drawBackground(.playerCamera);
			.players.each() using ( player ) {
				player.draw(.playerCamera, .currentMap);
			};
			//.localPlayer.draw(.playerCamera, .currentMap);
			.currentMap.drawForeground(.playerCamera);
		}
	}
	
	function onKeyDown( object event ) {
		if( .active and (not Console.active) ) {
			if( event.key == Engine.KEY_ESCAPE ) {
				Game.setState(Game.menuState());
			}
		}
	}
	
	function createPlayer( object message, boolean me ) {
		object player;
		
		if( .players.keyExists("Player/${message.id}") )
			return; // This should not be possible but for some reason this happens sometimes.
		
		Console.printLine("creating player... ${me} (${message.id})");
		
		player = new Player();
		player.id = message.id;
		//player.name = message.name;
		player.me = me;
		player.health = Global.PlayerStartHealth;
		player.speed = Global.PlayerSpeed;
		player.turningSpeed = Global.PlayerTurningSpeed;
		player.x = message.x;
		player.y = message.y;
		
		if( me ) {
			//Console.printLine('using keyboard controller.');
			player.controller = new KeyboardPlayerController(player);
			player.controller.keyLeft = Engine.KEY_LEFT;
			player.controller.keyRight = Engine.KEY_RIGHT;
			player.controller.keyShoot = Engine.KEY_SPACE;
			.localPlayer = player;
		} else {
			player.controller = new NetworkPlayerController(player);
		}
		
		player.weapon = new MachineGun(player);
		
		.players["Player/${player.id}"] = player;
		Game.players[] = player;
	}
	
	function onConnect( object message ) {
		if( .active ) {
		}
	}
	function onDisconnectMe( object message ) {
		if( .active ) {
			Game.setState(Game.menuState());
		}
	}
	function onNewPlayer( object message ) {
		if( .active ) {
			boolean me = false;
			if( not .connected ) {
				me = true;
				.connected = true;
			}
			.createPlayer(message, me);
		}
	}
}

class OldMenuState extends State {
	object mainMenu;
	object multiplayerMenu;
	object currentMenu;
	function init() {
		object testState = new TestState();
		object font = Engine.loadFont('font-10.png', 10, 10);
		.mainMenu = new Menu();
		.mainMenu.setSelector('Menu/simple-selector.png');
		.mainMenu.addItem(new TextMenuItem(font, "test", closure {
			Game.setState(testState);
		}));
		.mainMenu.addItem(new TextMenuItem(font, "multiplayer", closure {
			Game.setState(Game.multiplayerState());
		}));
		.mainMenu.addItem(new TextMenuItem(font, "options"));
		.mainMenu.addItem(new TextMenuItem(font, "credits"));
		.mainMenu.addItem(new TextMenuItem(font, "quit", closure {
			Game.quit();
		}));
		.mainMenu.active = true;
		.multiplayerMenu = new Menu();
		.currentMenu = .mainMenu;
		.active = true;
		if( not .listenersRegistered ) {
			EventHandler.registerListener(Engine.EVENT_KEYDOWN, self);
			.listenersRegistered = true;
		}
	}
	function quit() {
		.active = false;
		.mainMenu = null;
		.multiplayerMenu = null;
		.currentMenu = null;
	}
	function update() {
		
	}
	function draw() {
		.currentMenu.draw();
	}
	function onKeyDown( object event ) {
		if( .active and (not Console.active) ) {
			if( event.key == Engine.KEY_ESCAPE ) {
				if( .currentMenu == .mainMenu ) {
					Game.quit();
				}
			}
		}
	}
}

class MenuState extends State {
	object mainMenu;
	object startMenu;
	object joinMenu;
	object settingsMenu;
	object currentMenu;
	boolean menusInited = false;
	function init() {
		if( not .menusInited ) {
			.mainMenu = new ImageMenu();
			.mainMenu.setImage("main_menu_indexed.png");
			.mainMenu.addInvisibleButton("StartButton", 500, 108, 250, 100) using {
				.currentMenu.setActive(false);
				.startMenu.setActive(true);
				.currentMenu = .startMenu;
			};
			.mainMenu.addInvisibleButton("JoinButton", 500, 241, 250, 100) using {
				.currentMenu.setActive(false);
				.joinMenu.setActive(true);
				.currentMenu = .joinMenu;
			};
			.mainMenu.addInvisibleButton("SettingsButton", 500, 374, 250, 100) using {
				.currentMenu.setActive(false);
				.settingsMenu.setActive(true);
				.currentMenu = .settingsMenu;
			};
			.mainMenu.addInvisibleButton("QuitButton", 500, 507, 250, 100) using {
				Game.quit();
			};
		
			.startMenu = new ImageMenu();
			.startMenu.setImage("create_menu_indexed.png");

			.joinMenu = new ImageMenu();
			.joinMenu.setImage("join_menu_indexed.png");
			.joinMenu.addInvisibleTextfield("PlayerNameTextfield", 567, 347, 309, 27, 15);
			.joinMenu.addInvisibleTextfield("IPAddressTextfield", 567, 419, 309, 27, 15);

			.settingsMenu = new ImageMenu();
			.settingsMenu.setImage("settings_menu_indexed.png");
			// show fps
			.settingsMenu.addInvisibleCheckBox("ShowFpsCheckBox", 547, 459, 32, 29, false) using {
				// Do nothing
			};
			// low quality
			.settingsMenu.addInvisibleCheckBox("LowQualityCheckBox", 915, 459, 32, 29, false) using {
				Console.printLine('click');
			};
			// windowed mode
			.settingsMenu.addInvisibleCheckBox("WindowedModeCheckBox", 675, 520, 32, 29, (not Global.DefaultFullScreenState)) using {
				Console.printLine('click');
			};
			// back
			.settingsMenu.addInvisibleButton("BackButton", 212, 585, 250, 100) using {
				.currentMenu.setActive(false);
				.mainMenu.setActive(true);
				.currentMenu = .mainMenu;
			};
			// ok
			.settingsMenu.addInvisibleButton("OkButton", 817, 585, 250, 100) using {
				number newScreenWidth = 1024;
				number newScreenHeight = 768;
				boolean fullscreen = (not .settingsMenu.getItem("WindowedModeCheckBox").checked);
				string selectedResolution = .settingsMenu.getItem("ScreenResolutionSlider").selectedOption;
				if( selectedResolution == "1280x720" ) {
					newScreenWidth = 1280;
					newScreenHeight = 720;
				} else if( selectedResolution == "1280x800" ) {
					newScreenWidth = 1280;
					newScreenHeight = 800;
				} else if ( selectedResolution == "1280x1024" ) {
					newScreenWidth = 1280;
					newScreenHeight = 1024;
				}
				Engine.setScreen(newScreenWidth, newScreenHeight, fullscreen);
				Game.showFPS = .settingsMenu.getItem("ShowFpsCheckBox").checked;
				.currentMenu.setActive(false);
				.mainMenu.setActive(true);
				.currentMenu = .mainMenu;
			};
			// aspect ratio
			.settingsMenu.addInvisibleSlider("AspectRatioSlider", 275, 304, 730, 27, [ "4:3", "16:9", "16:10" ]) using ( string item ) {
				if( item == "4:3" ) {
					.settingsMenu.getItem("AspectRatioLabel").setImage("GUI/4_3.png");
					.settingsMenu.getItem("ScreenResolutionSlider").options = [ "1024x768", "1280x1024" ];
					.settingsMenu.getItem("ScreenResolutionSlider").selectedOption = "1024x768";
					.settingsMenu.getItem("ResolutionLabel").setImage("GUI/1024_768.png");
				} else if( item == "16:10" ) {
					.settingsMenu.getItem("AspectRatioLabel").setImage("GUI/16_10.png");
					.settingsMenu.getItem("ScreenResolutionSlider").options = [ "1280x800" ];
					.settingsMenu.getItem("ScreenResolutionSlider").selectedOption = "1280x800";
					.settingsMenu.getItem("ResolutionLabel").setImage("GUI/1280_800.png");
				} else if( item == "16:9" ) {
					.settingsMenu.getItem("AspectRatioLabel").setImage("GUI/16_9.png");
					.settingsMenu.getItem("ScreenResolutionSlider").options = [ "1280x720" ];
					.settingsMenu.getItem("ScreenResolutionSlider").selectedOption = "1280x720";
					.settingsMenu.getItem("ResolutionLabel").setImage("GUI/1280_720.png");
				}
			};
			// resolution
			.settingsMenu.addInvisibleSlider("ScreenResolutionSlider", 275, 398, 730, 27, [ "1024x768", "1280x1024" ]) using ( string item ) {
				if( item == "1024x768" ) .settingsMenu.getItem("ResolutionLabel").setImage("GUI/1024_768.png");
				else if( item == "1280x720" ) .settingsMenu.getItem("ResolutionLabel").setImage("GUI/1280_720.png");
				else if( item == "1280x800" ) .settingsMenu.getItem("ResolutionLabel").setImage("GUI/1280_800.png");
				else if( item == "1280x1024" ) .settingsMenu.getItem("ResolutionLabel").setImage("GUI/1280_1024.png");
			};
			.settingsMenu.getItem("ScreenResolutionSlider").selectedOption = "1024x768";
			// aspect ratio text
			.settingsMenu.addImage("AspectRatioLabel", 600, 253);
			.settingsMenu.getItem("AspectRatioLabel").setImage("GUI/4_3.png");
			// resolution text
			.settingsMenu.addImage("ResolutionLabel", 600, 347);
			.settingsMenu.getItem("ResolutionLabel").setImage("GUI/1024_768.png");
			
			.menusInited = true;
		}
		
		.currentMenu and .currentMenu.setActive(false);
		.currentMenu = .mainMenu;
		.currentMenu.setActive(true);
		
		.active = true;
		
		if( not .listenersRegistered ) {
			EventHandler.registerListener(Engine.EVENT_KEYDOWN, self);
			.mainMenu.registerListeners();
			.startMenu.registerListeners();
			.joinMenu.registerListeners();
			.settingsMenu.registerListeners();
			.listenersRegistered = true;
		}
	}
	function quit() {
		.active = false;
	}
	function update() {
	
	}
	function draw() {
		.currentMenu and .currentMenu.draw();
	}
	function onKeyDown( object event ) {
		if( .active and (not Console.active) ) {
			if( event.key == Engine.KEY_ESCAPE ) {
				if( .currentMenu == .mainMenu ) {
					Game.quit();
				} else {
					.currentMenu.setActive(false);
					.mainMenu.setActive(true);
					.currentMenu = .mainMenu;
				}
			}
		}
	}
}

